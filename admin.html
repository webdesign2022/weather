<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>NANO BANANA - ADMIN CONSOLE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: monospace; padding: 20px; }
        .card { background-color: #2d2d2d; border: 1px solid #444; margin-bottom: 20px; }
        .card-header { background-color: #333; border-bottom: 1px solid #444; font-weight: bold; color: #00FFFF; }
        .form-control, .form-select { background-color: #222; border: 1px solid #555; color: white; }
        .form-control:focus { background-color: #333; color: white; }
        
        /* ç‹€æ…‹ç‡ˆ */
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #00FF00; box-shadow: 0 0 5px #00FF00; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; font-size: 14px; }
        th { color: #888; }
        td { padding: 8px; border-bottom: 1px solid #444; }
        tr:hover { background-color: #333; }

        /* å±éšªæŒ‰éˆ• */
        .btn-danger-glow { background: #500; border: 1px solid red; color: white; }
        .btn-danger-glow:hover { background: #f00; box-shadow: 0 0 15px red; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12 d-flex justify-content-between align-items-center mb-4">
                <h3>ğŸŒ NANO BANANA <span style="color:#00FFFF">GOD VIEW</span></h3>
                <div id="connection-status" class="text-secondary">é€£ç·šä¸­...</div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card p-3 text-center">
                            <h5 class="text-muted">ç¸½è£ç½®æ•¸</h5>
                            <h2 id="total-devices">0</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 text-center">
                            <h5 class="text-muted">ä»Šæ—¥å£½æ˜Ÿ</h5>
                            <h2 id="birthday-count" style="color:#FF00FF">0</h2>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>è£ç½®ç›£æ§åˆ—è¡¨</span>
                        <input type="text" id="search-input" class="form-control form-control-sm" style="width: 200px;" placeholder="æœå°‹ IDã€ç”Ÿæ—¥ (12-25)..." onkeyup="filterTable()">
                    </div>
                    <div class="card-body p-0" style="height: 500px; overflow-y: auto;">
                        <table class="table table-dark table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>ç‹€æ…‹</th>
                                    <th>è£ç½® ID</th>
                                    <th>æ”¶ç¦®äºº (æš±ç¨±)</th>
                                    <th>ç”Ÿæ—¥</th>
                                    <th>é€ç¦®è€…</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="device-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                
                <div class="card">
                    <div class="card-header">ğŸš€ å–®ä¸€/ç¯©é¸ æ¨æ’­</div>
                    <div class="card-body">
                        <label>ç›®æ¨™è£ç½® ID:</label>
                        <input type="text" id="target-id" class="form-control mb-2" placeholder="é»é¸å·¦å´åˆ—è¡¨è‡ªå‹•å¸¶å…¥">
                        
                        <label>ç™¼é€è¨Šæ¯:</label>
                        <input type="text" id="single-msg" class="form-control mb-3" placeholder="ä¾‹å¦‚: ç”Ÿæ—¥å¿«æ¨‚ï¼">
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="sendToTarget()">ç™¼é€è¨Šæ¯</button>
                            <button class="btn btn-outline-info btn-sm" onclick="fillMsg('ğŸ‚ Happy Birthday!')">å¥—ç”¨: ç”Ÿæ—¥ç¥ç¦</button>
                            <button class="btn btn-outline-warning btn-sm" onclick="fillMsg('âš¡ ç³»çµ±ç¶­è­·é€šçŸ¥')">å¥—ç”¨: ç¶­è­·é€šçŸ¥</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="border-color: red;">
                    <div class="card-header text-danger">â˜¢ï¸ å…¨æœå»£æ’­ (Broadcast)</div>
                    <div class="card-body">
                        <p class="small text-muted">è­¦å‘Šï¼šé€™æœƒè¦†è“‹ã€Œæ‰€æœ‰ã€åœ¨ç·šè£ç½®ç›®å‰çš„ç•«é¢ã€‚</p>
                        
                        <label>å»£æ’­è¨Šæ¯:</label>
                        <input type="text" id="broadcast-msg" class="form-control mb-3" placeholder="ä¾‹å¦‚: Happy New Year 2026!">
                        
                        <div class="d-grid">
                            <button class="btn btn-danger-glow" onclick="sendBroadcast()">ğŸ”´ ç™¼é€çµ¦æ‰€æœ‰äºº (ALL)</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

   <script>
        // ==========================================
        // âš ï¸ è«‹å¡«å…¥è·Ÿ index.html ä¸€æ¨¡ä¸€æ¨£çš„ Config âš ï¸
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCX8XssChQjMIZZmNPYuQY93Pv5YMcYrrw",
			authDomain: "weather-mvp-5e7a4.firebaseapp.com",
			databaseURL: "https://weather-mvp-5e7a4-default-rtdb.firebaseio.com",
			projectId: "weather-mvp-5e7a4",
			storageBucket: "weather-mvp-5e7a4.firebasestorage.app",
			messagingSenderId: "305516610730",
			appId: "1:305516610730:web:9db2a3396beb95a7eb3cd3"
        };
        // ==========================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. ç›£è½é€£ç·šç‹€æ…‹
        const tableBody = document.getElementById('device-table-body');
        let allDevices = [];

        db.ref('.info/connected').on('value', snap => {
            const statusDiv = document.getElementById('connection-status');
            if (snap.val() === true) {
                statusDiv.innerHTML = '<span style="color:#00FF00">ğŸŸ¢ ç³»çµ±é€£ç·šæ­£å¸¸</span>';
            } else {
                statusDiv.innerHTML = '<span style="color:red">ğŸ”´ æ–·ç·šä¸­ (è«‹æª¢æŸ¥ Config)</span>';
            }
        });

        // 2. è®€å–è³‡æ–™ (ä¿®æ­£æ¬„ä½åç¨±)
        db.ref('devices').on('value', snapshot => {
            tableBody.innerHTML = '';
            allDevices = [];
            let count = 0;
            let bdayCount = 0;

            const today = new Date();
            const todayStr = String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const id = child.key;
                    const data = child.val();
                    const settings = data.settings || {}; 
                    
                    // ğŸŒŸ ä¿®æ­£é»ï¼šåŒæ™‚ç›¸å®¹ V7 çš„ recipientName å’Œ V9 çš„ recipient
                    const recName = settings.recipient || settings.recipientName || '(æœªè¨­å®š)';
                    const sender = settings.pairedBy || '(æœªçŸ¥)';
                    const bday = settings.birthday || '-';

                    // åˆ¤æ–·å£½æ˜Ÿ
                    let isBday = false;
                    if (bday !== '-' && bday.endsWith(todayStr)) {
                        isBday = true;
                        bdayCount++;
                    }

                    const deviceObj = {
                        id: id,
                        name: recName,
                        birthday: bday,
                        sender: sender,
                        isBday: isBday
                    };
                    allDevices.push(deviceObj);
                    count++;
                });
            }

            // æ›´æ–°å„€è¡¨æ¿
            document.getElementById('total-devices').innerText = count;
            document.getElementById('birthday-count').innerText = bdayCount;

            renderTable(allDevices);
        });

        // 3. æ¸²æŸ“è¡¨æ ¼
        function renderTable(devices) {
            tableBody.innerHTML = '';
            if (devices.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æš«ç„¡è£ç½®è³‡æ–™</td></tr>';
                return;
            }

            devices.forEach(d => {
                const row = document.createElement('tr');
                if(d.isBday) row.style.background = "#4a1c4a";

                row.innerHTML = `
                    <td><span class="status-dot online"></span></td>
                    <td style="font-family:monospace; color:#00FFFF;">${d.id}</td>
                    <td>${d.name} ${d.isBday ? 'ğŸ‚' : ''}</td>
                    <td>${d.birthday}</td>
                    <td class="text-muted">${d.sender}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-light" onclick="selectDevice('${d.id}')">é¸å–</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 4. ç¯©é¸
        function filterTable() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allDevices.filter(d => 
                d.id.toLowerCase().includes(query) || 
                d.birthday.includes(query) ||
                d.name.toLowerCase().includes(query)
            );
            renderTable(filtered);
        }

        // 5. æ“ä½œ
        function selectDevice(id) { document.getElementById('target-id').value = id; }
        function fillMsg(text) { document.getElementById('single-msg').value = text; }

        function sendToTarget() {
            const id = document.getElementById('target-id').value;
            const msg = document.getElementById('single-msg').value;
            if(!id || !msg) return alert("è«‹è¼¸å…¥ ID å’Œè¨Šæ¯");

            db.ref('devices/' + id + '/message').set({
                text: msg,
                timestamp: Date.now(),
                from: 'ADMIN'
            }).then(() => alert(`å·²ç™¼é€çµ¦ ${id}`));
        }

        function sendBroadcast() {
            const msg = document.getElementById('broadcast-msg').value;
            if(!msg) return alert("è«‹è¼¸å…¥å…§å®¹");
            if(!confirm("ç¢ºå®šå…¨é«”å»£æ’­ï¼Ÿ")) return;

            const updates = {};
            allDevices.forEach(d => {
                updates['devices/' + d.id + '/message'] = {
                    text: msg,
                    timestamp: Date.now(),
                    from: 'BROADCAST'
                };
            });
            db.ref().update(updates).then(() => alert("å»£æ’­å·²ç™¼é€"));
        }
    </script>
</body>
</html>