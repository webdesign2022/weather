<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>NANO BANANA V6.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background-color: #000; color: #fff; font-family: 'Roboto', sans-serif; height: 100vh; overflow: hidden; }

        /* === å…±ç”¨ UI å…ƒä»¶ === */
        .btn {
            background: linear-gradient(135deg, #00FFFF, #0088FF); color: black;
            border: none; padding: 15px 30px; font-size: 18px; font-weight: bold;
            border-radius: 30px; cursor: pointer; margin: 10px; width: 80%; max-width: 300px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .input-field {
            background: #222; border: 1px solid #444; color: white;
            padding: 15px; border-radius: 10px; width: 80%; max-width: 300px;
            font-size: 16px; margin-bottom: 15px; text-align: center;
        }
        h2 { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; color: #00FFFF; }

        /* === 1. å…¥å£é  (Landing Page) === */
        #landing-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #000; z-index: 5000;
        }
        .hero-logo { font-size: 50px; font-family: 'Orbitron', sans-serif; color: #00FFFF; margin-bottom: 50px; text-shadow: 0 0 20px #00FFFF; }

        /* === 2. è¨»å†Šé  (Registration) === */
        #register-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            background: #111; z-index: 4000;
        }

        /* === 3. é…å°é  (Pairing Input) === */
        #pairing-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            background: #111; z-index: 4000;
        }

        /* === 4. é¡¯ç¤ºç«¯ - å·¨å‹é…å°ç¢¼ (Unpaired State) === */
        #huge-code-overlay {
            position: absolute; width: 100%; height: 100%;
            display: none; /* é è¨­éš±è—ï¼Œé‚è¼¯æ§åˆ¶é¡¯ç¤º */
            flex-direction: column; align-items: center; justify-content: center;
            background: black; z-index: 20;
        }
        .pairing-code {
            font-family: 'Orbitron', sans-serif; font-size: 60px; /* è¶…å¤§å­—é«” */
            color: #FFFF00; font-weight: bold; text-shadow: 0 0 20px #FFFF00;
            animation: rotate 10s linear infinite; /* ç·©æ…¢æ—‹è½‰å¸å¼•æ³¨æ„ */
        }
        .scan-hint { margin-top: 10px; color: #666; font-size: 12px; }

        /* === 5. é¡¯ç¤ºç«¯ - ä¸»ç¨‹å¼ (Display Mode) === */
        #display-mode { display: none; width: 100%; height: 100%; }
        .holo-container { 
            position: absolute; width: 320px; height: 320px; 
            top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); 
        }
        .face { position: absolute; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; z-index: 1; }
        .ui-overlay { position: absolute; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; text-align: center; }
        .time { font-size: 22px; font-weight: 800; color: #fff; text-shadow: 2px 2px 0px #000; line-height: 1; }
        .msg-text { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 800; color: #FF00FF; text-shadow: 0 0 10px #FF00FF; overflow: hidden; word-break: break-all; animation: popIn 0.5s; }
        
        .top { top: 0; left: 110px; transform: rotate(180deg); }
        .bottom { bottom: 0; left: 110px; }
        .left { top: 110px; left: 0; transform: rotate(90deg); }
        .right { top: 110px; right: 0; transform: rotate(-90deg); }

        /* === 6. æ§åˆ¶ç«¯ - ä¸»æ§å° (Control Mode) === */
        #control-mode { display: none; padding: 30px; text-align: center; background: #111; height: 100vh; }
        .preset-btn { background: #333; color: #FFF; width: 48%; margin-bottom: 10px; }
        
        /* éš±è—çš„å•Ÿå‹•å±¤ (é¡¯ç¤ºç«¯ç”¨) */
        #start-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="hero-logo">ğŸŒ NANO</div>
        <p style="color:#666; margin-bottom:40px;">HOLO-DOCK SYSTEM V6.0</p>
        
        <button class="btn" onclick="selectRole('display')">ğŸ“º æˆ‘æ˜¯é¡¯ç¤ºå™¨<br><span style="font-size:12px; font-weight:normal;">(æ”¾å…¥åº•åº§çš„èˆŠæ‰‹æ©Ÿ)</span></button>
        <button class="btn" style="background:linear-gradient(135deg, #FF00FF, #FF8800);" onclick="selectRole('remote')">ğŸ“± æˆ‘æ˜¯é™æ§å™¨<br><span style="font-size:12px; font-weight:normal;">(ç¾åœ¨ç”¨çš„æ‰‹æ©Ÿ)</span></button>
    </div>

    <div id="register-page">
        <h2>å»ºç«‹æª”æ¡ˆ</h2>
        <p style="color:#888; margin-bottom:30px;">è®“æˆ‘å€‘èªè­˜ä½ ï¼Œä»¥ä¾¿æä¾›ç”Ÿæ—¥é©šå–œ</p>
        <input type="text" id="reg-name" class="input-field" placeholder="ä½ çš„æš±ç¨±">
        <input type="date" id="reg-bday" class="input-field">
        <button class="btn" onclick="submitRegistration()">ä¸‹ä¸€æ­¥ âœ</button>
    </div>

    <div id="pairing-page">
        <h2>è£ç½®é…å°</h2>
        <p style="color:#888; margin-bottom:30px;">è«‹è¼¸å…¥é¡¯ç¤ºå™¨ä¸Šçš„é»ƒè‰² 4 ä½æ•¸ä»£ç¢¼</p>
        <input type="text" id="pair-code" class="input-field" placeholder="ä¾‹å¦‚: 8888" maxlength="4" style="font-size:24px; letter-spacing:5px; font-family:monospace;">
        <button class="btn" onclick="submitPairing()">ğŸ”— é€£ç·šé…å°</button>
    </div>

    <div id="start-layer" onclick="startDisplay()"></div> <div id="display-mode">
        <div class="holo-container">
            <div id="huge-code-overlay">
                <div class="pairing-code" id="huge-code-text">----</div>
            </div>

            <div id="holo-content">
                <div class="face top" id="f-top"></div>
                <div class="face bottom" id="f-bottom"></div>
                <div class="face left" id="f-left"></div>
                <div class="face right" id="f-right"></div>
            </div>
        </div>
    </div>

    <div id="control-mode">
        <h2>NANO REMOTE</h2>
        <div id="welcome-msg" style="color:#00FFFF; margin-bottom:20px;"></div>
        
        <label style="color:gray; display:block; margin-bottom:10px;">ç™¼é€è¨Šæ¯</label>
        <input type="text" id="msg-input" class="input-field" placeholder="è¼¸å…¥å…§å®¹..." style="width:100%;">
        <button class="btn" onclick="sendMsg()" style="width:100%;">ğŸš€ ç™¼é€</button>
        
        <div style="display:flex; flex-wrap:wrap; justify-content:space-between; margin-top:20px;">
            <button class="btn preset-btn" onclick="sendPreset('â¤ï¸ æƒ³ä½ äº†')">â¤ï¸ æƒ³ä½ äº†</button>
            <button class="btn preset-btn" onclick="sendPreset('ä»Šæ™šåƒç«é‹ï¼Ÿ')">ä»Šæ™šåƒç«é‹ï¼Ÿ</button>
            <button class="btn preset-btn" onclick="sendPreset('å¸¶å‚˜ â˜”')">å¸¶å‚˜ â˜”</button>
            <button class="btn preset-btn" onclick="sendPreset('åŠ æ²¹ ğŸ’ª')">åŠ æ²¹ ğŸ’ª</button>
        </div>
        <div id="status" style="color:#00FF00; margin-top:20px;"></div>
        
        <p style="margin-top:50px; color:#333; font-size:12px; cursor:pointer;" onclick="clearData()">é‡ç½® App (æ¸…é™¤è³‡æ–™)</p>
    </div>

    <script>
        // ==========================================
        // âš ï¸ CONFIG å€åŸŸ âš ï¸
        // ==========================================
        const firebaseConfig = {
             apiKey: "AIzaSyCX8XssChQjMIZZmNPYuQY93Pv5YMcYrrw",
             authDomain: "weather-mvp-5e7a4.firebaseapp.com",
             databaseURL: "https://weather-mvp-5e7a4-default-rtdb.firebaseio.com",
             projectId: "weather-mvp-5e7a4",
             storageBucket: "weather-mvp-5e7a4.firebasestorage.app",
             messagingSenderId: "305516610730",
             appId: "1:305516610730:web:9db2a3396beb95a7eb3cd3"
        };
        // ==========================================

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰è§’è‰² (è‡ªå‹•ç™»å…¥)
        const savedRole = localStorage.getItem('nano_role');
        if (savedRole === 'display') {
            document.getElementById('landing-page').style.display = 'none';
            setupDisplay();
        } else if (savedRole === 'remote') {
            document.getElementById('landing-page').style.display = 'none';
            // æª¢æŸ¥æ˜¯å¦è¨»å†Šé
            if (localStorage.getItem('nano_user_name')) {
                // æª¢æŸ¥æ˜¯å¦é…å°é
                if (localStorage.getItem('nano_target_id')) {
                    setupRemote();
                } else {
                    document.getElementById('pairing-page').style.display = 'flex';
                }
            } else {
                document.getElementById('register-page').style.display = 'flex';
            }
        }

        // 1. è§’è‰²é¸æ“‡é‚è¼¯
        function selectRole(role) {
            localStorage.setItem('nano_role', role);
            document.getElementById('landing-page').style.display = 'none';
            
            if (role === 'display') {
                setupDisplay();
            } else {
                // é™æ§å™¨æµç¨‹ï¼šå…ˆè¨»å†Š -> å†é…å° -> å†æ§åˆ¶
                document.getElementById('register-page').style.display = 'flex';
            }
        }

        // 2. é™æ§å™¨ - è¨»å†Šæµç¨‹
        function submitRegistration() {
            const name = document.getElementById('reg-name').value;
            const bday = document.getElementById('reg-bday').value;
            if (!name) { alert("è«‹è¼¸å…¥æš±ç¨±"); return; }
            
            localStorage.setItem('nano_user_name', name);
            localStorage.setItem('nano_user_bday', bday);
            
            // è½‰å ´åˆ°é…å°é 
            document.getElementById('register-page').style.display = 'none';
            document.getElementById('pairing-page').style.display = 'flex';
        }

       // ä¿®æ”¹ submitPairing å‡½æ•¸
        function submitPairing() {
            const code = document.getElementById('pair-code').value.trim().toUpperCase();
            if (code.length !== 4) { alert("è«‹è¼¸å…¥ 4 ä½æ•¸ä»£ç¢¼"); return; }
            
            // æš«å­˜é…å°ç¢¼ï¼Œå…ˆä¸å¯«å…¥è³‡æ–™åº«ï¼Œå…ˆè½‰å ´å»å¡«å¯«ã€Œæ”¶ç¦®äººè³‡æ–™ã€
            localStorage.setItem('temp_target_id', code);
            
            document.getElementById('pairing-page').style.display = 'none';
            document.getElementById('setup-page').style.display = 'flex'; // é¡¯ç¤ºè¨­å®šé 
        }

        // æ–°å¢ï¼šæäº¤è£ç½®è¨­å®š (é€™æ˜¯é€ç¦®çš„é—œéµæ­¥é©Ÿ)
        function submitDeviceSetup() {
            const targetID = localStorage.getItem('temp_target_id');
            const nickname = document.getElementById('device-nickname').value; // ä¾‹å¦‚ Amy
            const bday = document.getElementById('device-bday').value;         // ä¾‹å¦‚ 12-25
            
            // é€™è£¡æ˜¯é™æ§è€…çš„åå­— (Tony)
            const myName = localStorage.getItem('nano_user_name'); 

            if(!nickname || !bday) { alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ä»¥ä¾¿æä¾›ç”Ÿæ—¥é©šå–œ"); return; }

            // å¯«å…¥ Firebase (å®Œæ•´çš„è£ç½®äººè¨­)
            db.ref('devices/' + targetID + '/settings').set({
                recipientName: nickname, // æ”¶ç¦®äººåå­—
                birthday: bday,          // æ”¶ç¦®äººç”Ÿæ—¥
                pairedBy: myName,        // é€ç¦®äººåå­—
                setupDate: Date.now()
            }).then(() => {
                // æ­£å¼å®Œæˆé…å°
                localStorage.setItem('nano_target_id', targetID);
                document.getElementById('setup-page').style.display = 'none';
                setupRemote();
                
                // é †ä¾¿ç™¼é€ç¬¬ä¸€æ¢æ­¡è¿è¨Šæ¯
                pushToCloud(`Hi ${nickname}! è¨­å®šå®Œæˆ`, targetID);
            });
        }

        // 4. é™æ§å™¨ - ä¸»æ§å°é‚è¼¯
        function setupRemote() {
            document.getElementById('control-mode').style.display = 'block';
            const name = localStorage.getItem('nano_user_name');
            document.getElementById('welcome-msg').innerText = `Hi, ${name} (å·²é€£ç·š)`;
        }

        function sendMsg() {
            const text = document.getElementById('msg-input').value;
            if(!text) return;
            pushToCloud(text);
        }
        function sendPreset(text) { pushToCloud(text); }
        function pushToCloud(text) {
            const targetID = localStorage.getItem('nano_target_id');
            db.ref('devices/' + targetID + '/message').set({
                text: text, timestamp: Date.now()
            }).then(() => {
                document.getElementById('status').innerText = "ç™¼é€æˆåŠŸ";
                setTimeout(()=>document.getElementById('status').innerText="", 2000);
            });
        }

        // 5. é¡¯ç¤ºç«¯ - é‚è¼¯
        function setupDisplay() {
            document.getElementById('display-mode').style.display = 'block';
            
            // å–å¾—æˆ–ç”¢ç”Ÿ ID
            let myDeviceID = localStorage.getItem('nano_device_id');
            if (!myDeviceID) {
                myDeviceID = Math.random().toString(36).substring(2, 6).toUpperCase(); // 4ç¢¼ ID
                localStorage.setItem('nano_device_id', myDeviceID);
            }

            // é¡¯ç¤ºå•Ÿå‹•å±¤ (ç­‰å¾…é»æ“Š)
            document.getElementById('start-layer').style.display = 'block';
            
            // ç›£è½æ˜¯å¦æœ‰ä¸»äºº (é…å°ç‹€æ…‹)
            db.ref('devices/' + myDeviceID + '/owner').on('value', snap => {
                const owner = snap.val();
                if (owner) {
                    // å·²é…å°ï¼šéš±è—å·¨ç¢¼ï¼Œé¡¯ç¤ºå¤©æ°£
                    document.getElementById('huge-code-overlay').style.display = 'none';
                } else {
                    // æœªé…å°ï¼šé¡¯ç¤ºå·¨ç¢¼ (å››å€‹é¢éƒ½è¦é¡¯ç¤º)
                    showHugeCode(myDeviceID);
                }
            });

            // ç›£è½è¨Šæ¯
            db.ref('devices/' + myDeviceID + '/message').on('value', snap => {
                const data = snap.val();
                if(data && (Date.now() - data.timestamp < 10000)) {
                    showMessage(data.text);
                }
            });

            // å¤©æ°£ Loop
            setInterval(() => {
                // å¦‚æœæ­£åœ¨é¡¯ç¤ºè¨Šæ¯æˆ–å·¨ç¢¼ï¼Œå°±ä¸æ›´æ–°å¤©æ°£
                if(document.getElementById('huge-code-overlay').style.display === 'flex') return;
                
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit' });
                // é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥ç”¨ CSS ç”¢ç”Ÿå¤©æ°£ä»‹é¢
                const html = `
                    <video src="weather.mp4" class="bg-video" muted loop playsinline></video>
                    <div class="ui-overlay">
                        <div class="time">${time}</div>
                        <div style="font-size:10px; color:yellow;">TAIPEI</div>
                    </div>
                `;
                updateFaces(html);
                document.querySelectorAll('video').forEach(v => v.play().catch(()=>{}));
            }, 1000);
        }

        // é¡¯ç¤ºç«¯ - é»æ“Šå•Ÿå‹•
        function startDisplay() {
            document.getElementById('start-layer').style.display = 'none';
            // å˜—è©¦æ’­æ”¾
            const videos = document.querySelectorAll('video');
            if(videos.length) videos.forEach(v => v.play().catch(()=>{}));
        }

        // è¼”åŠ©åŠŸèƒ½ï¼šé¡¯ç¤ºå·¨å‹é…å°ç¢¼
       // ä¿®æ­£å¾Œçš„é¡¯ç¤ºå·¨ç¢¼å‡½å¼
       function showHugeCode(code) {
            const overlay = document.getElementById('huge-code-overlay');
            overlay.style.display = 'flex';
            
            // ğŸŒŸ é—œéµä¿®æ­£ï¼šæŠŠ "----" æ›¿æ›æˆçœŸæ­£çš„ ID
            document.getElementById('huge-code-text').innerText = code;
            
            // ä¸‹é¢é€™æ®µæ˜¯ç‚ºäº†è®“é‡‘å­—å¡”å››å€‹é¢ä¹Ÿé¡¯ç¤º (å¦‚æœä½ å·²ç¶“æ”¾é€²åº•åº§)
            const html = `
                <div style="width:100%; height:100%; background:black; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div style="font-size:40px; color:yellow; font-weight:bold; font-family:monospace;">${code}</div>
                    <div style="font-size:10px; color:gray;">WAITING PAIR</div>
                </div>
            `;
            updateFaces(html);
        }
        function showMessage(text) {
             const html = `
                <div class="ui-overlay" style="background:black;">
                    <div class="msg-text">${text}</div>
                </div>
            `;
            updateFaces(html);
        }

        function updateFaces(html) {
            ['f-top', 'f-bottom', 'f-left', 'f-right'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = html;
            });
        }

        function clearData() {
            if(confirm("ç¢ºå®šè¦é‡ç½®ï¼Ÿé€™æœƒæ¸…é™¤é…å°å’Œè¨»å†Šè³‡æ–™ã€‚")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>