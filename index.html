<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>NANO BANANA V9.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background-color: #000; color: #fff; font-family: 'Roboto', sans-serif; height: 100vh; overflow: hidden; }

        /* === UI å…ƒä»¶ === */
        .btn { background: linear-gradient(135deg, #00FFFF, #0088FF); color: black; border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .input-field { background: #222; border: 1px solid #444; color: white; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; margin-bottom: 15px; text-align: center; }
        
        /* é é¢åˆ‡æ› */
        .page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 30px; background: #000; z-index: 10; overflow-y: auto; }
        .center-layout { justify-content: center; align-items: center; }

        /* === é¡¯ç¤ºç«¯ (Display) === */
        .holo-container { position: absolute; width: 320px; height: 320px; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); }
        .face { position: absolute; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        
        /* å½±ç‰‡å±¤ */
        .bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.8; z-index: 1; transition: opacity 1s; }
        
        /* è³‡è¨Šå±¤ (å¤©æ°£æ¨¡å¼æ‰é¡¯ç¤º) */
        .ui-overlay { position: absolute; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; text-align: center; transition: opacity 0.5s; }
        .time { font-size: 22px; font-weight: 800; color: #fff; text-shadow: 2px 2px 0px #000; line-height: 1; }
        .weather-info { font-size: 10px; color: #FFFF00; font-weight: bold; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 10px; margin-top: 5px; }

        /* è¨Šæ¯æ–‡å­— */
        .msg-text { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 800; color: #FF00FF; text-shadow: 0 0 10px #FF00FF; overflow: hidden; word-break: break-all; animation: popIn 0.5s; }

        /* å·¨ç¢¼å±¤ */
        #huge-code-overlay { position: absolute; width: 100%; height: 100%; display: none; background: black; z-index: 20; }
        .pairing-code { font-family: 'Orbitron', monospace; font-size: 50px; color: #FFFF00; font-weight: bold; animation: rotate 10s linear infinite; }

        .top { top: 0; left: 110px; transform: rotate(180deg); }
        .bottom { bottom: 0; left: 110px; }
        .left { top: 110px; left: 0; transform: rotate(90deg); }
        .right { top: 110px; right: 0; transform: rotate(-90deg); }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* === æ§åˆ¶ç«¯ (Remote) === */
        /* ä¸»é¡Œå•†åº—å¡ç‰‡ */
        .store-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .theme-card { background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .theme-card:hover { border-color: #00FFFF; background: #333; }
        .theme-card.active { border-color: #00FFFF; background: #004444; box-shadow: 0 0 10px #00FFFF; }
        .theme-icon { font-size: 24px; margin-bottom: 5px; }
        .theme-name { font-size: 12px; color: #ccc; }

        .device-card { background: #222; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #333; }
        select { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #444; border-radius: 5px; }

        /* å•Ÿå‹•å±¤ */
        #start-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }
        #device-id-tag { position: fixed; top: 15px; left: 15px; z-index: 999; color: rgba(255,255,255,0.3); font-size: 10px; font-family: monospace; pointer-events: none; }
    </style>
</head>
<body>

    <div id="landing-page" class="page center-layout" style="display:flex;">
        <h1 style="font-family:'Orbitron'; color:#00FFFF; font-size:50px; margin-bottom:10px;">ğŸŒ NANO</h1>
        <p style="color:#666; margin-bottom:50px;">CONTENT STORE V9.0</p>
        <button class="btn" onclick="selectRole('display')">ğŸ“º æˆ‘æ˜¯é¡¯ç¤ºå™¨</button>
        <button class="btn" style="background:transparent; border:1px solid #00FFFF; color:#00FFFF" onclick="selectRole('remote')">ğŸ“± æˆ‘æ˜¯é™æ§å™¨</button>
    </div>

    <div id="register-page" class="page center-layout">
        <h2>å»ºç«‹æª”æ¡ˆ</h2>
        <input type="text" id="reg-name" class="input-field" placeholder="ä½ çš„æš±ç¨±">
        <button class="btn" onclick="submitReg()">ä¸‹ä¸€æ­¥</button>
    </div>
    <div id="pairing-page" class="page center-layout">
        <h2>æ–°å¢è£ç½®</h2>
        <input type="text" id="pair-code" class="input-field" placeholder="è¼¸å…¥é»ƒè‰²ä»£ç¢¼" maxlength="4">
        <button class="btn" onclick="submitPairing()">ğŸ”— é€£ç·šé…å°</button>
        <button class="btn" style="background:transparent; border:1px solid #555; margin-top:10px;" onclick="cancelPairing()">å–æ¶ˆ</button>
    </div>
    <div id="setup-page" class="page center-layout">
        <h2>é€ç¦®è¨­å®š</h2>
        <input type="text" id="setup-name" class="input-field" placeholder="å°æ–¹æš±ç¨±">
        <input type="date" id="setup-bday" class="input-field">
        <button class="btn" onclick="submitSetup()">å®Œæˆ</button>
    </div>

    <div id="control-page" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:#00FFFF;">NANO REMOTE</h3>
            <span id="user-display" style="font-size:12px; color:#888;"></span>
        </div>

        <div class="device-card">
            <label style="color:#888; font-size:12px;">æ§åˆ¶è£ç½®</label>
            <div style="display:flex; gap:10px;">
                <select id="device-select" onchange="switchDevice()"></select>
                <button onclick="showPairingPage()" style="width:auto; padding:10px 15px; margin:0;">â•</button>
            </div>
            <div id="connection-status" style="font-size:12px; color:#00FF00; margin-top:5px;">â— ç·šä¸Š</div>
        </div>

        <label style="color:#00FFFF; font-size:14px; margin-bottom:10px; display:block;">THEME STORE (åˆ‡æ›é »é“)</label>
        <div class="store-grid">
            <div class="theme-card active" onclick="sendTheme('weather')">
                <div class="theme-icon">ğŸŒ¤ï¸</div>
                <div class="theme-name">å³æ™‚å¤©æ°£</div>
            </div>
            <div class="theme-card" onclick="sendTheme('jellyfish')">
                <div class="theme-icon">ğŸª¼</div>
                <div class="theme-name">ç™‚ç™’æ°´æ¯</div>
            </div>
            <div class="theme-card" onclick="sendTheme('rain')">
                <div class="theme-icon">ğŸŒ§ï¸</div>
                <div class="theme-name">é›¨å¤©æ°›åœ</div>
            </div>
            <div class="theme-card" onclick="sendTheme('cyber')">
                <div class="theme-icon">ğŸ¤–</div>
                <div class="theme-name">è³½åšé¾å…‹</div>
            </div>
        </div>

        <label style="color:gray; font-size:12px; margin-bottom:5px; display:block;">ç™¼é€æ–‡å­—</label>
        <input type="text" id="msg-input" class="input-field" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button class="btn" onclick="sendMsg()">ğŸš€ ç™¼é€</button>
        <div id="toast" style="text-align:center; color:#00FF00; margin-top:20px; height:20px;"></div>
    </div>

    <div id="start-layer" onclick="startDisplay()"></div>
    <div id="display-page" class="page" style="padding:0; background:black;">
        <div class="holo-container">
            <div id="huge-code-overlay">
                <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="pairing-code" id="huge-text">----</div>
                    <div style="font-size:10px; color:gray;">WAITING PAIR</div>
                </div>
            </div>
            <div class="face top" id="f-top"></div>
            <div class="face bottom" id="f-bottom"></div>
            <div class="face left" id="f-left"></div>
            <div class="face right" id="f-right"></div>
        </div>
        <div id="disp-id-tag"></div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ 1. Firebase Config âš ï¸
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCX8XssChQjMIZZmNPYuQY93Pv5YMcYrrw",
			authDomain: "weather-mvp-5e7a4.firebaseapp.com",
			databaseURL: "https://weather-mvp-5e7a4-default-rtdb.firebaseio.com",
			projectId: "weather-mvp-5e7a4",
			storageBucket: "weather-mvp-5e7a4.firebasestorage.app",
			messagingSenderId: "305516610730",
			appId: "1:305516610730:web:9db2a3396beb95a7eb3cd3"
        };
        // ==========================================
        // âš ï¸ 2. OpenWeatherMap API Key (é¸å¡«) âš ï¸
        // å¦‚æœæ²’å¡«ï¼Œç³»çµ±æœƒé€²å…¥ã€Œæ¨¡æ“¬å¤©æ°£æ¨¡å¼ã€
        // ==========================================
        const WEATHER_API_KEY = "2a9f23e62ebd74a5f2a78e10c105dca7"; 
        // ==========================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // é é¢è·¯ç”±èˆ‡åˆå§‹åŒ–
        const role = localStorage.getItem('nano_role');
        if (role === 'display') { switchPage('display-page'); initDisplay(); }
        else if (role === 'remote') {
            if (localStorage.getItem('nano_user')) {
                if (getLocalDevices().length > 0) { switchPage('control-page'); initRemote(); }
                else switchPage('pairing-page');
            } else switchPage('register-page');
        } else switchPage('landing-page');

        function switchPage(id) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = (id === 'landing-page') ? 'flex' : (id.includes('control') ? 'block' : 'flex');
        }
        function selectRole(r) { localStorage.setItem('nano_role', r); location.reload(); }

        // === é™æ§å™¨åŠŸèƒ½ ===
        // (è¨»å†Šé…å°é‚è¼¯åŒ V8ï¼Œç‚ºç¯€çœé•·åº¦ç•¥éé‡è¤‡éƒ¨åˆ†ï¼Œç›´æ¥é€²å…¥æ ¸å¿ƒ)
        function submitReg() { localStorage.setItem('nano_user', document.getElementById('reg-name').value); switchPage('pairing-page'); }
        function showPairingPage() { switchPage('pairing-page'); }
        function cancelPairing() { switchPage('control-page'); }
        function submitPairing() { localStorage.setItem('temp_pair_id', document.getElementById('pair-code').value.trim().toUpperCase()); switchPage('setup-page'); }
        function submitSetup() {
            const id = localStorage.getItem('temp_pair_id');
            const name = document.getElementById('setup-name').value;
            db.ref('devices/'+id+'/settings').set({ recipient: name, pairedBy: localStorage.getItem('nano_user') }).then(()=>{
                addLocalDevice(id, name); switchPage('control-page'); initRemote();
            });
        }
        
        // ğŸŒŸ æ–°åŠŸèƒ½ï¼šç™¼é€ä¸»é¡Œ (Theme)
        window.sendTheme = function(themeName) {
            const target = localStorage.getItem('nano_current_id');
            if(!target) return alert("æœªé¸æ“‡è£ç½®");

            // UI ç‹€æ…‹æ›´æ–°
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // å¯«å…¥ Firebase
            db.ref('devices/' + target + '/theme').set(themeName).then(() => {
                showToast("é »é“åˆ‡æ›: " + themeName);
            });
        };

        function sendMsg() {
            const target = localStorage.getItem('nano_current_id');
            const text = document.getElementById('msg-input').value;
            if(!text) return;
            db.ref('devices/' + target + '/message').set({ text: text, timestamp: Date.now() }).then(()=>showToast("å·²ç™¼é€"));
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; setTimeout(()=>t.innerText="", 2000);
        }

        // è£ç½®ç®¡ç†
        function getLocalDevices() { return JSON.parse(localStorage.getItem('nano_my_devices') || "[]"); }
        function addLocalDevice(id, name) {
            let list = getLocalDevices();
            if(!list.find(d=>d.id===id)) { list.push({id, name}); localStorage.setItem('nano_my_devices', JSON.stringify(list)); localStorage.setItem('nano_current_id', id); }
        }
        function initRemote() {
            document.getElementById('user-display').innerText = localStorage.getItem('nano_user');
            const sel = document.getElementById('device-select'); sel.innerHTML="";
            getLocalDevices().forEach(d => {
                const opt = document.createElement('option'); opt.value=d.id; opt.text=d.name; 
                if(d.id===localStorage.getItem('nano_current_id')) opt.selected=true;
                sel.appendChild(opt);
            });
        }
        window.switchDevice = function() { localStorage.setItem('nano_current_id', document.getElementById('device-select').value); }


        // === é¡¯ç¤ºç«¯æ ¸å¿ƒé‚è¼¯ (å¤©æ°£ + ä¸»é¡Œ) ===
        let currentTheme = 'weather'; // é è¨­
        let weatherData = { temp: 24, city: 'Taipei', desc: 'Clouds' }; // é è¨­è³‡æ–™

        function initDisplay() {
            let myID = localStorage.getItem('nano_device_id');
            if(!myID) { myID = Math.random().toString(36).substring(2,6).toUpperCase(); localStorage.setItem('nano_device_id', myID); }
            document.getElementById('disp-id-tag').innerText = "ID: " + myID;
            document.getElementById('start-layer').style.display = 'block';

            // 1. ç›£è½é…å°ç‹€æ…‹ (å·¨ç¢¼)
            db.ref('devices/'+myID+'/settings').on('value', s => {
                document.getElementById('huge-code-overlay').style.display = s.exists() ? 'none' : 'block';
                if(!s.exists()) showHugeCode(myID);
            });

            // 2. ç›£è½è¨Šæ¯
            db.ref('devices/'+myID+'/message').on('value', s => {
                const d = s.val();
                if(d && (Date.now()-d.timestamp < 10000)) showMessage(d.text);
            });

            // 3. ç›£è½ä¸»é¡Œåˆ‡æ›
            db.ref('devices/'+myID+'/theme').on('value', s => {
                const t = s.val();
                if(t) { currentTheme = t; renderScene(); }
            });

            // 4. å•Ÿå‹•å¤©æ°£æ›´æ–° (æ¯10åˆ†é˜æŠ“ä¸€æ¬¡çœŸå¯¦è³‡æ–™ï¼Œæˆ–æ¯ä¸€ç§’æ›´æ–°ç•«é¢)
            fetchWeather(); 
            setInterval(fetchWeather, 600000); // 10åˆ†é˜æ›´æ–°ä¸€æ¬¡å¤©æ°£API
            setInterval(renderScene, 1000); // æ¯ç§’æ›´æ–°ç•«é¢(æ™‚é–“)
        }

        // ğŸŒŸ æ ¸å¿ƒï¼šæŠ“å–å¤©æ°£
        function fetchWeather() {
            if (!WEATHER_API_KEY) {
                // æ¨¡æ“¬æ¨¡å¼ (æ²’å¡« Key æ™‚ç”¨éš¨æ©Ÿç”¢ç”Ÿ)
                console.log("æ¨¡æ“¬å¤©æ°£æ¨¡å¼");
                const weathers = ['Clear', 'Rain', 'Clouds'];
                const cities = ['Taipei', 'Tokyo', 'London', 'New York'];
                weatherData = {
                    temp: Math.floor(Math.random() * 15) + 15,
                    city: cities[Math.floor(Math.random() * cities.length)],
                    desc: weathers[Math.floor(Math.random() * weathers.length)]
                };
                return;
            }

            // çœŸå¯¦æ¨¡å¼ï¼šä½¿ç”¨ç€è¦½å™¨å®šä½
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${WEATHER_API_KEY}&units=metric`;
                    
                    fetch(url).then(res => res.json()).then(data => {
                        weatherData = {
                            temp: Math.round(data.main.temp),
                            city: data.name,
                            desc: data.weather[0].main // 'Clear', 'Rain', 'Clouds', 'Drizzle'
                        };
                        renderScene(); // æ‹¿åˆ°è³‡æ–™é¦¬ä¸Šæ›´æ–°ä¸€æ¬¡
                    }).catch(e => console.log("Weather Error:", e));
                });
            }
        }

        function startDisplay() {
            document.getElementById('start-layer').style.display = 'none';
            document.querySelectorAll('video').forEach(v=>v.play().catch(()=>{}));
        }

        // ğŸŒŸ æ ¸å¿ƒï¼šå ´æ™¯æ¸²æŸ“å™¨ (æ ¹æ“šä¸»é¡Œæ±ºå®šé¡¯ç¤ºä»€éº¼)
        let isShowingMsg = false;
        function renderScene() {
            if (isShowingMsg || document.getElementById('huge-code-overlay').style.display === 'block') return;

            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit' });
            
            let videoSrc = 'weather_clear.mp4'; // é è¨­
            let overlayHtml = '';

            if (currentTheme === 'weather') {
                // === å¤©æ°£æ¨¡å¼ ===
                // æ ¹æ“šå¤©æ°£ç‹€æ³é¸å½±ç‰‡
                const w = weatherData.desc.toLowerCase();
                if (w.includes('rain') || w.includes('drizzle')) videoSrc = 'weather_rain.mp4';
                else if (w.includes('clear')) videoSrc = 'weather_clear.mp4';
                else videoSrc = 'weather_clear.mp4'; // é™°å¤©ä¹Ÿå…ˆç”¨æ™´å¤©å½±ç‰‡ï¼Œæˆ–æ˜¯ä½ æœ‰ weather_cloud.mp4

                overlayHtml = `
                    <div class="time">${time}</div>
                    <div class="weather-info">${weatherData.city.toUpperCase()} ${weatherData.temp}Â°C</div>
                `;

            } else if (currentTheme === 'jellyfish') {
                // === æ°´æ¯æ¨¡å¼ ===
                videoSrc = 'theme_jelly.mp4';
                // æ°´æ¯æ¨¡å¼ä¸é¡¯ç¤ºæ–‡å­—ï¼Œåªè¦ç´”æ·¨ç•«é¢
                overlayHtml = ''; 
            } else if (currentTheme === 'cyber') {
                // === è³½åšé¾å…‹ ===
                 videoSrc = 'theme_jelly.mp4'; // æš«ç”¨
                 overlayHtml = `<div class="time" style="color:#00FFFF; text-shadow:0 0 10px blue;">${time}</div>`;
            }

            // æ›´æ–° DOM
            const html = `
                <video src="${videoSrc}" class="bg-video" muted loop playsinline></video>
                <div class="ui-overlay">${overlayHtml}</div>
            `;
            updateFaces(html);
            
            // ç¢ºä¿å½±ç‰‡æ’­æ”¾ (é˜²å¡é “)
            const vids = document.querySelectorAll('video');
            vids.forEach(v => {
                 // åªæœ‰ç•¶ src æ”¹è®Šæ™‚æ‰éœ€è¦é‡æ–° load/playï¼Œé¿å…ä¸€ç›´é‡ç½®
                 if (!v.currentSrc.includes(videoSrc)) {
                     v.src = videoSrc;
                     v.play().catch(()=>{});
                 } else if (v.paused) {
                     v.play().catch(()=>{});
                 }
            });
        }

        function showMessage(text) {
            isShowingMsg = true;
            document.getElementById('huge-code-overlay').style.display = 'none';
            const html = `<div class="ui-overlay" style="background:black;"><div class="msg-text">${text}</div></div>`;
            updateFaces(html);
            setTimeout(() => { isShowingMsg = false; renderScene(); }, 8000);
        }

        function showHugeCode(code) {
            document.getElementById('huge-code-overlay').style.display = 'block';
            const html = `<div style="width:100%;height:100%;background:black;display:flex;flex-direction:column;align-items:center;justify-content:center;"><div class="pairing-code">${code}</div><div style="font-size:10px;color:gray;">WAITING</div></div>`;
            updateFaces(html);
        }

        function updateFaces(html) {
            ['f-top', 'f-bottom', 'f-left', 'f-right'].forEach(id => {
                const el = document.getElementById(id);
                // é€™è£¡åšå€‹å°å„ªåŒ–ï¼šå¦‚æœ HTML æ²’è®Šå°±ä¸è¦å‹• DOMï¼Œç¯€çœæ•ˆèƒ½
                // ä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ MVP å…ˆç›´æ¥è¦†è“‹
                if(el) el.innerHTML = html;
            });
        }
    </script>
</body>
</html>