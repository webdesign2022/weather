<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>NANO BANANA V8.0</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background-color: #000; color: #fff; font-family: 'Roboto', sans-serif; height: 100vh; overflow: hidden; }

        /* === UI å…ƒä»¶ === */
        .btn { background: linear-gradient(135deg, #00FFFF, #0088FF); color: black; border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; width: 100%; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid #00FFFF; color: #00FFFF; }
        .input-field { background: #222; border: 1px solid #444; color: white; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; margin-bottom: 15px; text-align: center; }
        h2 { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; color: #00FFFF; text-align: center; margin-bottom: 30px; }

        /* === é é¢å®¹å™¨ (é è¨­éš±è—) === */
        .page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 30px; background: #000; z-index: 10; overflow-y: auto; }
        
        /* ç½®ä¸­ä½ˆå±€ç”¨ */
        .center-layout { justify-content: center; align-items: center; }

        /* === é¡¯ç¤ºç«¯ (Display) === */
        .holo-container { position: absolute; width: 320px; height: 320px; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); }
        .face { position: absolute; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; z-index: 1; }
        .ui-overlay { position: absolute; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; text-align: center; }
        .time { font-size: 22px; font-weight: 800; color: #fff; text-shadow: 2px 2px 0px #000; line-height: 1; }
        
        /* è¨Šæ¯æ–‡å­— */
        .msg-text { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 800; color: #FF00FF; text-shadow: 0 0 10px #FF00FF; overflow: hidden; word-break: break-all; animation: popIn 0.5s; }
        
        /* å››é¢æ—‹è½‰ */
        .top { top: 0; left: 110px; transform: rotate(180deg); }
        .bottom { bottom: 0; left: 110px; }
        .left { top: 110px; left: 0; transform: rotate(90deg); }
        .right { top: 110px; right: 0; transform: rotate(-90deg); }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* å·¨å‹é…å°ç¢¼é®ç½© */
        #huge-code-overlay { position: absolute; width: 100%; height: 100%; display: none; background: black; z-index: 20; }
        .pairing-code { font-family: 'Orbitron', monospace; font-size: 50px; color: #FFFF00; font-weight: bold; animation: rotate 10s linear infinite; }

        /* === æ§åˆ¶ç«¯ (Remote) === */
        .device-card { background: #222; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #333; }
        select { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #444; border-radius: 5px; font-size: 16px; margin-bottom: 10px; }
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .preset-btn { background: #333; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }

        /* å•Ÿå‹•å±¤ */
        #start-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="landing-page" class="page center-layout" style="display:flex;">
        <h1 style="font-family:'Orbitron'; color:#00FFFF; font-size:50px; margin-bottom:10px;">ğŸŒ NANO</h1>
        <p style="color:#666; margin-bottom:50px;">HOLO SYSTEM V8.0</p>
        <button class="btn" onclick="selectRole('display')">ğŸ“º æˆ‘æ˜¯é¡¯ç¤ºå™¨<br><small>(èˆŠæ‰‹æ©Ÿ)</small></button>
        <button class="btn btn-outline" onclick="selectRole('remote')">ğŸ“± æˆ‘æ˜¯é™æ§å™¨<br><small>(æ§åˆ¶ç«¯)</small></button>
    </div>

    <div id="register-page" class="page center-layout">
        <h2>å»ºç«‹æª”æ¡ˆ</h2>
        <input type="text" id="reg-name" class="input-field" placeholder="ä½ çš„æš±ç¨±">
        <button class="btn" onclick="submitReg()">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="pairing-page" class="page center-layout">
        <h2>æ–°å¢è£ç½®</h2>
        <p style="color:#888;">è«‹è¼¸å…¥é¡¯ç¤ºå™¨ä¸Šçš„é»ƒè‰²ä»£ç¢¼</p>
        <input type="text" id="pair-code" class="input-field" placeholder="ä¾‹å¦‚: A1B2" maxlength="4" style="letter-spacing:5px; font-family:monospace; font-size:24px;">
        <button class="btn" onclick="submitPairing()">ğŸ”— é€£ç·šé…å°</button>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="cancelPairing()">å–æ¶ˆ</button>
    </div>

    <div id="setup-page" class="page center-layout">
        <h2>é€™æ˜¯çµ¦èª°çš„ï¼Ÿ</h2>
        <input type="text" id="setup-name" class="input-field" placeholder="å°æ–¹æš±ç¨± (ä¾‹: Amy)">
        <input type="date" id="setup-bday" class="input-field">
        <button class="btn" onclick="submitSetup()">å®Œæˆè¨­å®š</button>
    </div>

    <div id="control-page" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:#00FFFF;">NANO REMOTE</h3>
            <span id="user-display" style="font-size:12px; color:#888;"></span>
        </div>

        <div class="device-card">
            <label style="color:#888; font-size:12px;">ç•¶å‰æ§åˆ¶è£ç½®</label>
            <div style="display:flex; gap:10px;">
                <select id="device-select" onchange="switchDevice()"></select>
                <button onclick="showPairingPage()" style="width:auto; padding:10px 15px; margin:0;">â•</button>
            </div>
            <div id="connection-status" style="font-size:12px; color:#00FF00; margin-top:5px;">â— å·²é€£ç·š</div>
        </div>

        <input type="text" id="msg-input" class="input-field" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button class="btn" onclick="sendMsg()">ğŸš€ ç™¼é€è¨Šæ¯</button>

        <div class="preset-grid">
            <button class="preset-btn" onclick="sendPreset('â¤ï¸ æƒ³ä½ äº†')">â¤ï¸ æƒ³ä½ äº†</button>
            <button class="preset-btn" onclick="sendPreset('ä»Šæ™šåƒç«é‹ï¼Ÿ')">åƒç«é‹ï¼Ÿ</button>
            <button class="preset-btn" onclick="sendPreset('è¨˜å¾—å¸¶å‚˜ â˜”')">å¸¶å‚˜ â˜”</button>
            <button class="preset-btn" onclick="sendPreset('åŠ æ²¹ ğŸ’ª')">åŠ æ²¹ ğŸ’ª</button>
        </div>
        <div id="toast" style="text-align:center; color:#00FF00; margin-top:20px; height:20px;"></div>
    </div>

    <div id="start-layer" onclick="startDisplay()"></div>
    <div id="display-page" class="page" style="padding:0; background:black;">
        <div class="holo-container">
            <div id="huge-code-overlay">
                <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div class="pairing-code" id="huge-text">----</div>
                    <div style="font-size:10px; color:gray;">WAITING PAIR</div>
                </div>
            </div>
            <div class="face top" id="f-top"></div>
            <div class="face bottom" id="f-bottom"></div>
            <div class="face left" id="f-left"></div>
            <div class="face right" id="f-right"></div>
        </div>
        <div style="position:fixed; top:10px; left:10px; color:#333; font-size:10px;" id="disp-id-tag"></div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ CONFIG âš ï¸
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCX8XssChQjMIZZmNPYuQY93Pv5YMcYrrw",
            authDomain: "weather-mvp-5e7a4.firebaseapp.com",
            databaseURL: "https://weather-mvp-5e7a4-default-rtdb.firebaseio.com",
            projectId: "weather-mvp-5e7a4",
            storageBucket: "weather-mvp-5e7a4.firebasestorage.app",
            messagingSenderId: "305516610730",
            appId: "1:305516610730:web:9db2a3396beb95a7eb3cd3"
        };
        // ==========================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // è‡ªå‹•ç™»å…¥åˆ¤æ–·
        const role = localStorage.getItem('nano_role');
        if (role === 'display') {
            switchPage('display-page');
            initDisplay();
        } else if (role === 'remote') {
            if (localStorage.getItem('nano_user')) {
                // æœ‰è¨»å†Šéï¼Œæª¢æŸ¥æ˜¯å¦æœ‰è£ç½®
                const devices = getLocalDevices();
                if (devices.length > 0) {
                    switchPage('control-page');
                    initRemote();
                } else {
                    switchPage('pairing-page');
                }
            } else {
                switchPage('register-page');
            }
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById(pageId).style.display = (pageId === 'landing-page') ? 'flex' : 'flex';
            if(pageId === 'control-page') document.getElementById(pageId).style.display = 'block';
        }

        function selectRole(r) {
            localStorage.setItem('nano_role', r);
            if (r === 'display') {
                switchPage('display-page');
                initDisplay();
            } else {
                if(localStorage.getItem('nano_user')) switchPage('pairing-page');
                else switchPage('register-page');
            }
        }

        // === é™æ§å™¨é‚è¼¯ ===
        function submitReg() {
            const name = document.getElementById('reg-name').value;
            if(!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
            localStorage.setItem('nano_user', name);
            switchPage('pairing-page');
        }

        function showPairingPage() { switchPage('pairing-page'); }
        function cancelPairing() { 
             if(getLocalDevices().length > 0) switchPage('control-page');
             else alert("è«‹è‡³å°‘é…å°ä¸€å€‹è£ç½®");
        }

        function submitPairing() {
            const code = document.getElementById('pair-code').value.trim().toUpperCase();
            if(code.length !== 4) return alert("è«‹è¼¸å…¥ 4 ç¢¼ ID");
            
            // æš«å­˜ ID
            localStorage.setItem('temp_pair_id', code);
            // è½‰å»è¨­å®šé 
            switchPage('setup-page');
        }

        function submitSetup() {
            const name = document.getElementById('setup-name').value || "æˆ‘çš„ NANO";
            const bday = document.getElementById('setup-bday').value;
            const id = localStorage.getItem('temp_pair_id');
            const owner = localStorage.getItem('nano_user');

            // å¯«å…¥ Firebase
            db.ref('devices/' + id + '/settings').set({
                recipient: name,
                birthday: bday,
                pairedBy: owner,
                timestamp: Date.now()
            }).then(() => {
                // å„²å­˜åˆ°æœ¬åœ°åˆ—è¡¨
                addLocalDevice(id, name);
                switchPage('control-page');
                initRemote();
            });
        }

        // è£ç½®åˆ—è¡¨ç®¡ç†
        function getLocalDevices() {
            return JSON.parse(localStorage.getItem('nano_my_devices') || "[]");
        }
        function addLocalDevice(id, name) {
            let list = getLocalDevices();
            // é¿å…é‡è¤‡
            if(!list.find(d => d.id === id)) {
                list.push({ id: id, name: name });
                localStorage.setItem('nano_my_devices', JSON.stringify(list));
                localStorage.setItem('nano_current_id', id); // è‡ªå‹•é¸ä¸­
            }
        }

        function initRemote() {
            const user = localStorage.getItem('nano_user');
            document.getElementById('user-display').innerText = user;
            updateDeviceSelect();
        }

        function updateDeviceSelect() {
            const list = getLocalDevices();
            const select = document.getElementById('device-select');
            const current = localStorage.getItem('nano_current_id');
            
            select.innerHTML = "";
            list.forEach(dev => {
                const opt = document.createElement('option');
                opt.value = dev.id;
                opt.text = `${dev.name} (${dev.id})`;
                if(dev.id === current) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function switchDevice() {
            const val = document.getElementById('device-select').value;
            localStorage.setItem('nano_current_id', val);
        }

        function sendMsg() {
            const text = document.getElementById('msg-input').value;
            if(!text) return;
            pushToCloud(text);
        }
        function sendPreset(text) { pushToCloud(text); }

        function pushToCloud(text) {
            const target = localStorage.getItem('nano_current_id');
            if(!target) return alert("æœªé¸æ“‡è£ç½®");

            // ğŸŒŸ ä¿®æ­£é‡é»ï¼šç¢ºä¿è·¯å¾‘æ˜¯ /messageï¼Œä¸¦ä¸”åŒ…å« timestamp
            db.ref('devices/' + target + '/message').set({
                text: text,
                timestamp: Date.now()
            }).then(() => {
                const t = document.getElementById('toast');
                t.innerText = "å·²ç™¼é€";
                setTimeout(()=>t.innerText="", 2000);
            });
        }

        // === é¡¯ç¤ºç«¯é‚è¼¯ ===
        function initDisplay() {
            let myID = localStorage.getItem('nano_device_id');
            if(!myID) {
                myID = Math.random().toString(36).substring(2, 6).toUpperCase();
                localStorage.setItem('nano_device_id', myID);
            }
            document.getElementById('disp-id-tag').innerText = "ID: " + myID;
            document.getElementById('start-layer').style.display = 'block'; // ç­‰å¾…é»æ“Š

            // ç›£è½æ˜¯å¦æœ‰ä¸»äºº (settings å­˜åœ¨)
            db.ref('devices/' + myID + '/settings').on('value', snap => {
                if(snap.exists()) {
                    // å·²é…å°ï¼šéš±è—å·¨ç¢¼
                    document.getElementById('huge-code-overlay').style.display = 'none';
                } else {
                    // æœªé…å°ï¼šé¡¯ç¤ºå·¨ç¢¼
                    showHugeCode(myID);
                }
            });

            // ç›£è½è¨Šæ¯
            db.ref('devices/' + myID + '/message').on('value', snap => {
                const data = snap.val();
                if(data && (Date.now() - data.timestamp < 15000)) { // 15ç§’å…§æœ‰æ•ˆ
                    showMessage(data.text);
                }
            });

            startWeatherLoop();
        }

        function startDisplay() {
            document.getElementById('start-layer').style.display = 'none';
            const v = document.querySelectorAll('video');
            if(v.length) v.forEach(vi => vi.play().catch(()=>{}));
        }

        function showHugeCode(code) {
            document.getElementById('huge-code-overlay').style.display = 'block';
            document.getElementById('huge-text').innerText = code;
            
            // åŒæ­¥æ›´æ–°å››å€‹é¢
            const html = `
               <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:black;">
                   <div style="font-size:40px; color:yellow; font-weight:bold;">${code}</div>
                   <div style="font-size:10px; color:gray;">WAITING</div>
               </div>
            `;
            updateFaces(html);
        }

        let isShowingMsg = false;
        function showMessage(text) {
            isShowingMsg = true;
            // ğŸŒŸ å¼·åˆ¶éš±è—å·¨ç¢¼å±¤ï¼Œç¢ºä¿è¨Šæ¯èƒ½è¢«çœ‹åˆ°
            document.getElementById('huge-code-overlay').style.display = 'none';

            const html = `
                <div class="ui-overlay" style="background:black;">
                    <div class="msg-text">${text}</div>
                </div>
            `;
            updateFaces(html);
            
            // 8ç§’å¾Œæ¢å¾©å¤©æ°£
            setTimeout(() => {
                isShowingMsg = false;
                // æª¢æŸ¥æ˜¯å¦é‚„æ²’é…å°ï¼Œå¦‚æœæ²’é…å°è¦ç§€å›å·¨ç¢¼
                // ä½†é€šå¸¸æœ‰è¨Šæ¯å°±æ˜¯å·²é…å°ï¼Œæ‰€ä»¥ç›´æ¥å›å¤©æ°£
            }, 8000);
        }

        function startWeatherLoop() {
            setInterval(() => {
                if(isShowingMsg) return;
                // å¦‚æœæ­£åœ¨é¡¯ç¤ºå·¨ç¢¼ (æœªé…å°)ï¼Œä¹Ÿä¸è¦è“‹æ‰å®ƒ
                if(document.getElementById('huge-code-overlay').style.display === 'block') return;

                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit' });
                
                const html = `
                    <video src="weather.mp4" class="bg-video" muted loop playsinline></video>
                    <div class="ui-overlay">
                        <div class="time">${time}</div>
                        <div style="font-size:10px; color:yellow;">TAIPEI</div>
                    </div>
                `;
                updateFaces(html);
                document.querySelectorAll('video').forEach(v => v.play().catch(()=>{}));
            }, 1000);
        }

        function updateFaces(html) {
            ['f-top', 'f-bottom', 'f-left', 'f-right'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = html;
            });
        }
    </script>
</body>
</html>