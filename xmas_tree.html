<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµ‚æ¥µç‰ˆæ‰‹å‹¢äº’å‹•è–èª•æ¨¹</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">

  <style>
    body { margin: 0; padding: 0; background-color: #000510; overflow: hidden; font-family: 'Cinzel', serif; }
    #video-container { position: absolute; top: 10px; left: 10px; width: 160px; height: 120px; z-index: 10; border: 1px solid #00ffff; box-shadow: 0 0 10px #00ffff; transform: scaleX(-1); opacity: 0.8; border-radius: 8px; background: #000;}
    video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    #status { position: absolute; bottom: 20px; left: 20px; color: #aaddff; font-size: 18px; font-weight: bold; text-shadow: 0 0 8px #00ffff; z-index: 10; pointer-events: none; letter-spacing: 2px; line-height: 1.5; }
    #gallery-img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 350px; max-height: 350px; display: none; border-radius: 50%; box-shadow: 0 0 50px rgba(255, 255, 255, 0.5); pointer-events: none; border: 4px solid rgba(255, 255, 255, 0.9); z-index: 5; object-fit: cover; aspect-ratio: 1/1; }
    #music-btn { position: absolute; top: 20px; right: 20px; z-index: 20; background: rgba(0, 50, 100, 0.4); border: 1px solid #00ffff; color: #00ffff; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-family: sans-serif; font-size: 14px; transition: all 0.3s; text-shadow: 0 0 5px #00ffff; }
    #music-btn:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 15px #00ffff; }
    .gesture-hint { position: absolute; top: 140px; left: 10px; color: rgba(255,255,255,0.7); font-size: 12px; font-family: sans-serif; line-height: 1.6; pointer-events: none; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; }
    .highlight { color: #00ffff; font-weight: bold; }
  </style>
</head>
<body>

  <div id="video-container">
    <video class="input_video" playsinline></video>
  </div>
  
  <div class="gesture-hint">
    <span class="highlight">ğŸ–ï¸ å¼µæ‰‹(5æŒ‡)</span>ï¼šæ•£é–‹äº’å‹•<br>
    <span class="highlight">ğŸ‘Œ OKæ‰‹å‹¢</span>ï¼šå†°é›ªèºæ—‹æ¨¹ (Style 0)<br>
    <span class="highlight">â˜ï¸ æ¯” 1</span>ï¼šç¶“å…¸æ¾æ¨¹ (Style 1)<br>
    <span class="highlight">âœŒï¸ æ¯” 2</span>ï¼šéœ“è™¹ DNA (Style 2)<br>
    <span class="highlight">ğŸ¤Ÿ æ¯” 3</span>ï¼šå±¤ç–Šè›‹ç³• (Style 3)<br>
    <span class="highlight">ğŸ–– æ¯” 4</span>ï¼šé‡å­çŸ©é™£ (Style 4)<br>
    <span class="highlight">ğŸ‘ æ¯”è®š</span>ï¼šç•«å»Šæ¨¡å¼ (æ—‹è½‰)<br>
    <span class="highlight">ğŸ¤ æåˆ</span>ï¼šé¡¯ç¤ºå–®å¼µç…§ç‰‡
  </div>

  <div id="status">ç³»çµ±å•Ÿå‹•ä¸­...</div>
  <button id="music-btn">ğŸµ æ’­æ”¾è–èª•éŸ³æ¨‚</button>
  <img id="gallery-img" src="" alt="Gallery Photo">
  
  <audio id="bg-music" loop>
      <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" type="audio/mpeg">
  </audio>

<script>
let particles = [];
// å„²å­˜ 5 ç¨®ä¸åŒé¢¨æ ¼çš„æ¨¹é»ä½
let treeStyles = [[], [], [], [], []]; 
let circlePoints = [];
let handX = 0, handY = 0;
let isHandDetected = false;
let currentMode = 'TREE'; 
let currentTreeStyle = 0; // 0=OK, 1=Index, 2=Victory, 3=Three, 4=Four
let galleryIndex = 0;
let lastGallerySwitchTime = 0;
let particleCount = 1300; 
let autoRotateAngle = 0;

let photoUrls = [
    'https://images.unsplash.com/photo-1544077960-604201fe74bc?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1511268559489-34b624fbfcf5?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1512389142860-9c449e58a543?auto=format&fit=crop&w=600&q=80',
    'https://images.unsplash.com/photo-1482638186012-59f940755237?auto=format&fit=crop&w=600&q=80'
];

const imgElement = document.getElementById('gallery-img');
const statusElement = document.getElementById('status');
const musicBtn = document.getElementById('music-btn');
const bgMusic = document.getElementById('bg-music');
let isMusicPlaying = false;

musicBtn.addEventListener('click', () => {
    if (isMusicPlaying) {
        bgMusic.pause();
        musicBtn.innerText = 'ğŸµ æ’­æ”¾è–èª•éŸ³æ¨‚';
        musicBtn.style.boxShadow = 'none';
    } else {
        bgMusic.play().catch(e => console.log("éŸ³æ¨‚æ’­æ”¾å¤±æ•—", e));
        musicBtn.innerText = 'â¸ æš«åœéŸ³æ¨‚';
        musicBtn.style.boxShadow = '0 0 15px #00ffff';
    }
    isMusicPlaying = !isMusicPlaying;
});

// --- P5.js Setup ---
function setup() {
  createCanvas(windowWidth, windowHeight);
  colorMode(HSB, 360, 100, 100, 1);
  textFont('Cinzel'); 
  
  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }
  
  // ä¸€æ¬¡è¨ˆç®—æ‰€æœ‰é¢¨æ ¼çš„é»
  calculateAllTreeStyles();
  calculateCirclePoints();
  
  setTimeout(() => {
     if(!isHandDetected) statusElement.innerText = "è‡ªå‹•å±•ç¤ºæ¨¡å¼ (æœªåµæ¸¬åˆ°æ‰‹)";
  }, 3000);
}

function draw() {
  // ä¾ç…§é¢¨æ ¼å¾®èª¿èƒŒæ™¯è‰²èª¿
  if (currentMode === 'TREE') {
      if (currentTreeStyle === 1) background(140, 60, 5, 0.35); // ç¶ è‰²ç³»èƒŒæ™¯
      else if (currentTreeStyle === 2) background(280, 60, 5, 0.35); // ç´«è‰²ç³»èƒŒæ™¯
      else background(220, 80, 8, 0.35); // é è¨­è—è‰²
  } else {
      background(220, 80, 8, 0.35);
  }

  autoRotateAngle += 0.005;

  // é¡¯ç¤ºæ–‡å­—
  if (currentMode === 'TREE') {
      push();
      textAlign(CENTER, CENTER);
      textSize(min(width / 12, 70));
      noStroke();
      drawingContext.shadowBlur = 30;
      
      // æ–‡å­—é¡è‰²éš¨é¢¨æ ¼æ”¹è®Š
      let textHue = 200;
      if (currentTreeStyle === 1) textHue = 50; // é‡‘
      if (currentTreeStyle === 2) textHue = 300; // ç²‰
      
      drawingContext.shadowColor = color(textHue, 60, 100); 
      fill(textHue, 10, 100); 
      text("MERRY CHRISTMAS", width / 2, height * 0.15);
      pop();
      drawingContext.shadowBlur = 0; 
  }

  // ç…§ç‰‡é¡¯ç¤º
  if (currentMode === 'GALLERY' || currentMode === 'PINCH') {
     imgElement.style.display = 'block';
     if (currentMode === 'GALLERY' && millis() - lastGallerySwitchTime > 2500) {
        nextPhoto();
        lastGallerySwitchTime = millis();
     }
  } else {
    imgElement.style.display = 'none';
  }

  // ç²’å­æ›´æ–°
  particles.forEach((p, index) => {
    let target = null;
    let isBackground = false;

    if (currentMode === 'TREE') {
        // æ ¹æ“šç›®å‰çš„ style é¸æ“‡å°æ‡‰çš„é»ä½é™£åˆ—
        let currentPoints = treeStyles[currentTreeStyle];
        let treeIndex = index % currentPoints.length;
        
        // è‡ªå‹•æ—‹è½‰é‚è¼¯
        if (!isHandDetected) {
            target = currentPoints[treeIndex]; // è‡ªå‹•æ—‹è½‰åœ¨ behaviors è™•ç†
        } else {
            target = currentPoints[treeIndex];
        }

        // --- é¡è‰²ä¸»é¡Œè¨­å®š ---
        let h, s, b;
        switch(currentTreeStyle) {
            case 0: // OK: å†°é›ªè—
                h = random(170, 210); s = random(50, 90); b = random(80, 100);
                if(random(1)>0.95) {h=200;s=0;b=100;} // é–ƒçˆç™½
                break;
            case 1: // Style 1: ç¶“å…¸ç¶ é‡‘
                if (random(1) > 0.8) { h = 45; s = 80; b = 100; } // é‡‘é£¾
                else { h = random(90, 140); s = random(60, 90); b = random(40, 80); } // ç¶ è‘‰
                break;
            case 2: // Style 2: è³½åšéœ“è™¹ (ç²‰ç´« + é’)
                if (index % 2 === 0) h = random(280, 320); // ç´«ç²‰
                else h = random(160, 190); // é’
                s = 80; b = 100;
                break;
            case 3: // Style 3: éŠ€ç™½å±¤ç–Š
                h = 220; s = random(0, 30); b = random(70, 100); // éŠ€ç™½
                if(random(1)>0.9) { h=50; s=80; b=100; } // å¶çˆ¾é‡‘å…‰
                break;
            case 4: // Style 4: é‡å­çŸ©é™£ (å¤šè‰²æˆ–æ•¸æ“šç¶ )
                h = random(0, 360); s = 80; b = 100; // å½©è‰²ç²’å­
                break;
        }
        
        p.targetColor = color(h, s, b);
        p.maxSpeed = 15;

    } else if (currentMode === 'SCATTER') {
        target = null; 
        p.targetColor = color(0, 0, 100); // æ•£é–‹è®Šæˆç´”ç™½
        p.maxSpeed = 20;
    } else if (currentMode === 'GALLERY' || currentMode === 'PINCH') {
        if (index % 4 === 0) { 
            let circleIndex = (index / 4) % circlePoints.length;
            target = circlePoints[circleIndex];
            p.targetColor = color(330, 60, 100); // ç²‰è‰²ç›¸æ¡†
            p.maxSpeed = 12;
        } else {
            isBackground = true;
            p.targetColor = color(220, 80, 60, 0.5); 
        }
    }

    p.behaviors(target, handX, handY, currentMode, isBackground, isHandDetected);
    p.update();
    p.show();
  });
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  calculateAllTreeStyles();
  calculateCirclePoints();
}

function nextPhoto() {
    galleryIndex = (galleryIndex + 1) % photoUrls.length;
    imgElement.src = photoUrls[galleryIndex];
}

// --- ç²’å­é¡åˆ¥ ---
class Particle {
  constructor() {
    this.pos = createVector(random(width), random(height));
    this.vel = createVector(random(-1, 1), random(-1, 1));
    this.acc = createVector();
    this.maxSpeed = 10;
    this.maxForce = 0.4;
    this.currentColor = color(0, 0, 0, 0);
    this.targetColor = color(255);
    this.size = random(2, 4);
    this.angle = random(TWO_PI); 
    this.orbitRadius = random(width * 0.2, width * 0.8);
  }

  behaviors(target, hx, hy, mode, isBg, hasHand) {
    let mouse = createVector(hx, hy);
    
    // è‡ªå‹•æ—‹è½‰æ•ˆæœ (ç•¶åœ¨æ¨¹æ¨¡å¼ä¸”ç„¡æ‰‹ æˆ– åªæ˜¯æƒ³è®“æ¨¹è½‰å‹•)
    // é€™è£¡æˆ‘å€‘è®“æ¨¹æ°¸é å¾®å¾®è½‰å‹•ï¼Œçœ‹èµ·ä¾†æ›´æœ‰ç”Ÿå‘½åŠ›
    if (mode === 'TREE' && target) {
         let angle = (!hasHand) ? autoRotateAngle : autoRotateAngle * 0.2; // æœ‰æ‰‹æ™‚è½‰æ…¢ä¸€é»
         let cx = width/2;
         let cy = height/2;
         // ç¹ä¸­å¿ƒæ—‹è½‰ç›®æ¨™é»
         let tx = target.x - cx;
         let ty = target.y - cy; // å…ˆä¸è½‰ Yï¼Œåªè½‰ XZ å¹³é¢æŠ•å½±
         let rotatedX = tx * cos(angle) - (target.y - 250) * 0.2 * sin(angle); // å½ 3D
         
         // ç°¡å–®ç‰ˆï¼šç›´æ¥é£›å‘ç›®æ¨™ï¼Œä½†ç›®æ¨™å¦‚æœæ˜¯å‹•æ…‹çš„éœ€è¦åœ¨ calculate æ›´æ–°
         // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åœ¨é€™è£¡åšä¸€å€‹ç°¡å–®çš„åç§»
         let arrive = this.arrive(createVector(target.x, target.y));
         
         // å¦‚æœæ²’æ‰‹ï¼ŒåŠ ä¸€é»æ¼©æ¸¦åŠ›
         if (!hasHand) {
             let center = createVector(width/2, height/2);
             let steer = p5.Vector.sub(center, this.pos);
             steer.rotate(HALF_PI); // åˆ‡ç·šæ–¹å‘
             steer.setMag(0.5);
             this.applyForce(steer);
         }
         this.applyForce(arrive);
         return;
    }

    if (isBg) {
        let center = createVector(width/2, height/2);
        this.angle += 0.003; 
        let desiredX = center.x + cos(this.angle) * this.orbitRadius;
        let desiredY = center.y + sin(this.angle) * this.orbitRadius * 0.6; 
        let desiredPos = createVector(desiredX, desiredY);
        let steer = p5.Vector.sub(desiredPos, this.pos);
        steer.setMag(3);
        this.applyForce(steer);
    } else if (mode === 'SCATTER' && hasHand) {
        let flee = this.flee(mouse);
        flee.mult(8); 
        this.applyForce(flee);
        this.applyForce(p5.Vector.random2D().mult(0.5));
    } else if (target) {
        let arrive = this.arrive(createVector(target.x, target.y));
        arrive.mult(1.2);
        this.applyForce(arrive);
    } else {
        this.applyForce(p5.Vector.random2D().mult(0.1));
        this.vel.limit(2);
    }
  }

  arrive(target) {
    let desired = p5.Vector.sub(target, this.pos);
    let d = desired.mag();
    let speed = this.maxSpeed;
    if (d < 100) speed = map(d, 0, 100, 0, this.maxSpeed);
    desired.setMag(speed);
    let steer = p5.Vector.sub(desired, this.vel);
    steer.limit(this.maxForce);
    return steer;
  }

  flee(target) {
    let desired = p5.Vector.sub(target, this.pos);
    let d = desired.mag();
    if (d < 250) {
      desired.setMag(this.maxSpeed);
      desired.mult(-1);
      let steer = p5.Vector.sub(desired, this.vel);
      steer.limit(this.maxForce);
      return steer;
    }
    return createVector(0, 0);
  }

  applyForce(f) { this.acc.add(f); }

  update() {
    this.pos.add(this.vel);
    this.vel.add(this.acc);
    this.acc.mult(0);
    this.currentColor = lerpColor(this.currentColor, this.targetColor, 0.08);
  }

  show() {
    drawingContext.shadowBlur = this.size * 2; 
    drawingContext.shadowColor = this.currentColor;
    stroke(this.currentColor);
    strokeWeight(this.size);
    point(this.pos.x, this.pos.y);
    drawingContext.shadowBlur = 0; 
  }
}

// --- æ ¸å¿ƒï¼š5ç¨®æ¨¹çš„æ•¸å­¸ç”Ÿæˆ ---
function calculateAllTreeStyles() {
    let treeHeight = height * 0.75;
    let treeBaseY = height * 0.9;
    let treeTopY = treeBaseY - treeHeight;
    let cx = width / 2;

    // Style 0: OK - å†°é›ªèºæ—‹ (åŸæœ¬çš„)
    treeStyles[0] = [];
    let spirals = 6;
    let pts = floor(particleCount / spirals);
    for (let s = 0; s < spirals; s++) {
        let startAngle = (TWO_PI / spirals) * s;
        for (let i = 0; i < pts; i++) {
            let t = i / pts;
            let angle = startAngle + t * TWO_PI * 3;
            let radius = map(t, 0, 1, width*0.25, 0);
            let y = map(t, 0, 1, treeBaseY, treeTopY);
            let spread = random(-10, 10);
            treeStyles[0].push({x: cx + (radius+spread)*cos(angle), y: y});
        }
    }

    // Style 1: æ•¸å­—1 - ç¶“å…¸æ¾æ¨¹ (éš¨æ©Ÿå¡«å……åœ“éŒ)
    treeStyles[1] = [];
    for(let i=0; i<particleCount; i++) {
        let y = random(treeTopY, treeBaseY);
        let t = map(y, treeTopY, treeBaseY, 0, 1);
        let maxR = map(t, 0, 1, 0, width*0.28);
        // ä½¿ç”¨ sqrt è®“åˆ†ä½ˆå‡å‹»
        let r = maxR * sqrt(random(1));
        let angle = random(TWO_PI);
        treeStyles[1].push({x: cx + r*cos(angle), y: y});
    }

    // Style 2: æ•¸å­—2 - é›™è‚¡ DNA (å…©æ¢ç²—èºæ—‹)
    treeStyles[2] = [];
    for(let i=0; i<particleCount; i++) {
        let t = i / particleCount;
        let y = map(t, 0, 1, treeBaseY, treeTopY);
        let angle = t * TWO_PI * 6; // è½‰æ¯”è¼ƒå¤šåœˆ